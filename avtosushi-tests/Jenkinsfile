pipeline {
    agent any

    stages {
        stage('Checkout') {
            steps {
                echo 'üì• –ó–∞–±–∏—Ä–∞–µ–º –∫–æ–¥ –∏–∑ Git...'
                checkout scm
            }
        }

        stage('Prepare Environment') {
            steps {
                echo 'üîß –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è...'
                script {
                    dir('avtosushi-tests') {
                        // –í Windows –∏—Å–ø–æ–ª—å–∑—É–µ–º 'bat' –∏ –∫–æ–º–∞–Ω–¥—É npm
                        bat 'npm install -g newman newman-reporter-allure'
                        echo '‚úÖ Newman —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω (–∏–ª–∏ –æ–±–Ω–æ–≤–ª–µ–Ω)'
                    }
                }
            }
        }

        stage('Run Postman Tests') {
            steps {
                echo 'üöÄ –ó–∞–ø—É—Å–∫ Postman API —Ç–µ—Å—Ç–æ–≤...'
                script {
                    dir('avtosushi-tests') {
                        // –°–æ–∑–¥–∞–µ–º –ø–∞–ø–∫—É –¥–ª—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ (–∫–æ–º–∞–Ω–¥–∞ Windows)
                        bat 'if not exist "allure-results" mkdir allure-results'

                        // –ó–∞–ø—É—Å–∫–∞–µ–º Newman. –í–∞–∂–Ω–æ: –∏—Å–ø–æ–ª—å–∑—É–µ–º –±–∞—Ç-—Ñ–∞–π–ª newman.bat
                        // –∏ —ç–∫—Ä–∞–Ω–∏—Ä—É–µ–º –∫–∞–≤—ã—á–∫–∏ –¥–ª—è Windows
                        bat """
                            "%APPDATA%\\npm\\newman.cmd" run "Avtosushi.postman_collection.json" ^
        --environment "Avto.postman_environment.json" ^
        --reporters allure ^
        --reporter-allure-export allure-results ^
        --suppress-exit-code
                        """
                        echo '‚úÖ Postman —Ç–µ—Å—Ç—ã –∑–∞–≤–µ—Ä—à–µ–Ω—ã'
                    }
                }
            }
        }

        stage('Generate Allure Report') {
            steps {
                echo 'üìä –ì–µ–Ω–µ—Ä–∞—Ü–∏—è Allure –æ—Ç—á–µ—Ç–∞...'
                script {
                    dir('avtosushi-tests') {
                        // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –æ—Ç—á–µ—Ç. –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ—Ç—Å—è, —á—Ç–æ allure –µ—Å—Ç—å –≤ —Å–∏—Å—Ç–µ–º–µ.
                        bat 'allure generate allure-results -o allure-report --clean'
                    }
                }
            }
        }
    }

    post {
        always {
            echo 'üèÅ –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã...'
            // –ü—É–±–ª–∏–∫—É–µ–º Allure –æ—Ç—á–µ—Ç –∏–∑ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –ø–∞–ø–∫–∏
            allure includeProperties: false,
                  reportBuildPolicy: 'ALWAYS',
                  results: [[path: 'avtosushi-tests/allure-results']]

            // –ê—Ä—Ö–∏–≤–∞—Ü–∏—è HTML –æ—Ç—á–µ—Ç–∞
            archiveArtifacts artifacts: 'avtosushi-tests/allure-report/**', fingerprint: true
        }

        success {
            echo '‚úÖ –í—Å–µ —Ç–µ—Å—Ç—ã —É—Å–ø–µ—à–Ω–æ –ø—Ä–æ–π–¥–µ–Ω—ã!'
        }

        failure {
            echo '‚ùå –ù–µ–∫–æ—Ç–æ—Ä—ã–µ —Ç–µ—Å—Ç—ã —É–ø–∞–ª–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –æ—Ç—á–µ—Ç.'
        }
    }
}
